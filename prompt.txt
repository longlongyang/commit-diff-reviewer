# VSCode/Cursor æ’ä»¶å¼€å‘ Promptï¼šGit Commit å·®å¼‚å®¡æŸ¥å·¥å…·

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

è¯·å¼€å‘ä¸€ä¸ª VSCode/Cursor æ’ä»¶ï¼Œåä¸º **"Commit Diff Reviewer"**ï¼Œå®ç°ç±»ä¼¼ GitHub Copilot ä»£ç å®¡æŸ¥çš„äº¤äº’ä½“éªŒï¼Œä½†é’ˆå¯¹ Git commit çš„å·®å¼‚è¿›è¡Œå¯è§†åŒ–å®¡æŸ¥å’Œé€æ¡å¤„ç†ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 1. Commit é€‰æ‹©å™¨
- æä¾›å‘½ä»¤é¢æ¿å‘½ä»¤ï¼š`Commit Diff Reviewer: Select Commit to Review`
- å¼¹å‡º Quick Pick åˆ—è¡¨ï¼Œæ˜¾ç¤ºæœ€è¿‘ N ä¸ª commitsï¼ˆå¯é…ç½®ï¼Œé»˜è®¤ 20ï¼‰
- æ¯ä¸ªé€‰é¡¹æ˜¾ç¤ºï¼šcommit hashï¼ˆçŸ­ï¼‰ã€æäº¤ä¿¡æ¯ã€ä½œè€…ã€æ—¶é—´
- æ”¯æŒè¾“å…¥å®Œæ•´ commit hash ç›´æ¥é€‰æ‹©

### 2. å·®å¼‚é«˜äº®æ˜¾ç¤º
é€‰ä¸­ commit åï¼Œå¯¹å½“å‰å·¥ä½œåŒºä¸­**ç›¸å¯¹è¯¥ commit ä¿®æ”¹çš„æ‰€æœ‰æ–‡ä»¶**è¿›è¡Œå·®å¼‚é«˜äº®ï¼š

- **æ–°å¢è¡Œ**ï¼šç»¿è‰²èƒŒæ™¯é«˜äº® + å·¦ä¾§ç»¿è‰²è¾¹æ æ ‡è®°
- **åˆ é™¤è¡Œ**ï¼šçº¢è‰²èƒŒæ™¯é«˜äº®ï¼ˆä»¥ã€Œå¹½çµè¡Œã€æˆ–å†…è”åˆ é™¤çº¿å½¢å¼å±•ç¤ºï¼‰+ å·¦ä¾§çº¢è‰²è¾¹æ æ ‡è®°
- **ä¿®æ”¹è¡Œ**ï¼šé»„è‰²/æ©™è‰²èƒŒæ™¯é«˜äº®ï¼ŒåŒæ—¶å±•ç¤ºæ–°æ—§å†…å®¹å¯¹æ¯”

ä½¿ç”¨ VSCode çš„ `TextEditorDecorationType` API å®ç°é«˜äº®ã€‚

### 3. å·®å¼‚å¯¼èˆªç³»ç»Ÿ
- åœ¨ç¼–è¾‘å™¨çŠ¶æ€æ æ˜¾ç¤ºå¯¼èˆªæ§ä»¶ï¼š`< ä¸Šä¸€å¤„ | å½“å‰: 3/15 | ä¸‹ä¸€å¤„ >`
- å¿«æ·é”®æ”¯æŒï¼š
  - `Alt+[` æˆ– `F7`ï¼šè·³è½¬åˆ°ä¸Šä¸€å¤„æ”¹åŠ¨
  - `Alt+]` æˆ– `Shift+F7`ï¼šè·³è½¬åˆ°ä¸‹ä¸€å¤„æ”¹åŠ¨
- è·³è½¬æ—¶è‡ªåŠ¨æ»šåŠ¨å¹¶å°†æ”¹åŠ¨ç½®äºå±å¹•ä¸­å¤®
- æ”¯æŒè·¨æ–‡ä»¶è·³è½¬ï¼ˆæŒ‰æ–‡ä»¶é¡ºåºï¼‰

### 4. æ”¹åŠ¨å¤„ç†æ“ä½œ
æ¯å¤„æ”¹åŠ¨æ—è¾¹æ˜¾ç¤º CodeLens æˆ–æ‚¬æµ®æŒ‰é’®ï¼š

**æ¥å—æ”¹åŠ¨ (Accept)**
- è¡Œä¸ºï¼šä»…å–æ¶ˆè¯¥å¤„é«˜äº®ï¼Œä¿ç•™å½“å‰ä»£ç ä¸å˜
- è§†è§‰åé¦ˆï¼šé«˜äº®æ¸éšæ¶ˆå¤±

**æ‹’ç»æ”¹åŠ¨ (Reject)**
- è¡Œä¸ºï¼šå°†è¯¥å¤„ä»£ç  revert åˆ° commit çš„çŠ¶æ€ï¼Œç„¶åå–æ¶ˆé«˜äº®
- å¯¹äºæ–°å¢è¡Œï¼šåˆ é™¤è¿™äº›è¡Œ
- å¯¹äºåˆ é™¤è¡Œï¼šæ¢å¤è¿™äº›è¡Œ
- å¯¹äºä¿®æ”¹è¡Œï¼šæ¢å¤ä¸ºæ—§å†…å®¹

**å…¨éƒ¨æ¥å— / å…¨éƒ¨æ‹’ç»**
- æä¾›å‘½ä»¤ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å‰©ä½™æ”¹åŠ¨

### 5. çŠ¶æ€æŒä¹…åŒ–
- è®°å½•å½“å‰å®¡æŸ¥ä¼šè¯çŠ¶æ€ï¼ˆå“ªäº›æ”¹åŠ¨å·²å¤„ç†ï¼‰
- æ”¯æŒå…³é—­æ–‡ä»¶/ç¼–è¾‘å™¨åé‡æ–°æ‰“å¼€ç»§ç»­å®¡æŸ¥
- æä¾›å‘½ä»¤ï¼š`Commit Diff Reviewer: End Review Session` ç»“æŸå®¡æŸ¥å¹¶æ¸…é™¤æ‰€æœ‰çŠ¶æ€

---

## ğŸ—ï¸ æŠ€æœ¯å®ç°æŒ‡å¼•

### é¡¹ç›®ç»“æ„
```
commit-diff-reviewer/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ extension.ts          # æ’ä»¶å…¥å£
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ selectCommit.ts   # commit é€‰æ‹©é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ navigation.ts     # å¯¼èˆªå‘½ä»¤
â”‚   â”‚   â””â”€â”€ diffActions.ts    # æ¥å—/æ‹’ç»æ“ä½œ
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ decorationProvider.ts  # é«˜äº®è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ codeLensProvider.ts    # CodeLens æŒ‰é’®
â”‚   â”‚   â””â”€â”€ statusBarProvider.ts   # çŠ¶æ€æ æ§ä»¶
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ gitService.ts     # Git æ“ä½œå°è£…
â”‚   â”‚   â”œâ”€â”€ diffParser.ts     # diff è§£æå™¨
â”‚   â”‚   â””â”€â”€ sessionManager.ts # ä¼šè¯çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ types.ts          # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ helpers.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### å…³é”® API ä½¿ç”¨

```typescript
// 1. è·å– Git ä¿¡æ¯ - ä½¿ç”¨ VSCode å†…ç½® Git æ‰©å±•
const gitExtension = vscode.extensions.getExtension('vscode.git');
const git = gitExtension?.exports.getAPI(1);

// 2. æ‰§è¡Œ git diff å‘½ä»¤
import { exec } from 'child_process';
exec(`git diff ${commitHash}^ ${commitHash}`, { cwd: workspaceRoot }, callback);

// 3. åˆ›å»ºé«˜äº®è£…é¥°
const addedLineDecoration = vscode.window.createTextEditorDecorationType({
    backgroundColor: 'rgba(0, 255, 0, 0.2)',
    isWholeLine: true,
    overviewRulerColor: 'green',
    overviewRulerLane: vscode.OverviewRulerLane.Left
});

// 4. åº”ç”¨è£…é¥°
editor.setDecorations(addedLineDecoration, ranges);

// 5. CodeLens Provider
class DiffCodeLensProvider implements vscode.CodeLensProvider {
    provideCodeLenses(document: vscode.TextDocument): vscode.CodeLens[] {
        // è¿”å›æ¯å¤„æ”¹åŠ¨çš„ Accept/Reject æŒ‰é’®
    }
}
```

### Diff è§£ææ ¸å¿ƒé€»è¾‘

```typescript
interface DiffHunk {
    filePath: string;
    oldStart: number;
    oldLines: number;
    newStart: number;
    newLines: number;
    changes: Array<{
        type: 'add' | 'delete' | 'modify';
        oldContent?: string;
        newContent?: string;
        lineNumber: number;
    }>;
}

function parseDiffOutput(diffOutput: string): DiffHunk[] {
    // è§£æ unified diff æ ¼å¼
    // å¤„ç† @@ -a,b +c,d @@ æ ‡è®°
    // è¯†åˆ« +/- å¼€å¤´çš„è¡Œ
}
```

### å…³é”®æ³¨æ„äº‹é¡¹

1. **è¡Œå·åŒæ­¥é—®é¢˜**ï¼š
   - ç”¨æˆ·å¯èƒ½åœ¨å®¡æŸ¥è¿‡ç¨‹ä¸­ç¼–è¾‘æ–‡ä»¶ï¼Œéœ€è¦ç›‘å¬ `onDidChangeTextDocument` äº‹ä»¶
   - å®æ—¶æ›´æ–°æ”¹åŠ¨ä½ç½®çš„è¡Œå·æ˜ å°„

2. **Revert æ“ä½œçš„åŸå­æ€§**ï¼š
   - æ‹’ç»æ“ä½œéœ€è¦ç²¾ç¡®æ›¿æ¢ï¼Œè€ƒè™‘ä½¿ç”¨ `WorkspaceEdit` API
   - å¤„ç†å¤šè¡Œæ”¹åŠ¨æ—¶ä¿æŒäº‹åŠ¡æ€§

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å¤§æ–‡ä»¶/å¤§é‡æ”¹åŠ¨æ—¶ä½¿ç”¨è™šæ‹ŸåŒ–æˆ–æ‡’åŠ è½½
   - è£…é¥°å™¨æŒ‰éœ€æ›´æ–°ï¼Œé¿å…å…¨é‡åˆ·æ–°

4. **è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼š
   - æ–‡ä»¶å·²è¢«åˆ é™¤/é‡å‘½å
   - äºŒè¿›åˆ¶æ–‡ä»¶
   - Merge commitsï¼ˆå¤šä¸ª parentï¼‰
   - å†²çªçŠ¶æ€

---

## ğŸ“¦ package.json é…ç½®è¦ç‚¹

```json
{
  "name": "commit-diff-reviewer",
  "displayName": "Commit Diff Reviewer",
  "description": "Review and selectively accept/reject changes from any Git commit",
  "version": "0.0.1",
  "engines": { "vscode": "^1.74.0" },
  "categories": ["Other"],
  "activationEvents": [
    "onCommand:commitDiffReviewer.selectCommit"
  ],
  "main": "./out/extension.js",
  "contributes": {
    "commands": [
      { "command": "commitDiffReviewer.selectCommit", "title": "Select Commit to Review", "category": "Commit Diff Reviewer" },
      { "command": "commitDiffReviewer.nextChange", "title": "Go to Next Change" },
      { "command": "commitDiffReviewer.prevChange", "title": "Go to Previous Change" },
      { "command": "commitDiffReviewer.acceptChange", "title": "Accept Current Change" },
      { "command": "commitDiffReviewer.rejectChange", "title": "Reject Current Change" },
      { "command": "commitDiffReviewer.acceptAll", "title": "Accept All Changes" },
      { "command": "commitDiffReviewer.rejectAll", "title": "Reject All Changes" },
      { "command": "commitDiffReviewer.endSession", "title": "End Review Session" }
    ],
    "keybindings": [
      { "command": "commitDiffReviewer.nextChange", "key": "alt+]", "when": "commitDiffReviewer.inSession" },
      { "command": "commitDiffReviewer.prevChange", "key": "alt+[", "when": "commitDiffReviewer.inSession" },
      { "command": "commitDiffReviewer.acceptChange", "key": "alt+a", "when": "commitDiffReviewer.inSession" },
      { "command": "commitDiffReviewer.rejectChange", "key": "alt+r", "when": "commitDiffReviewer.inSession" }
    ],
    "configuration": {
      "title": "Commit Diff Reviewer",
      "properties": {
        "commitDiffReviewer.maxCommitsInList": {
          "type": "number",
          "default": 20,
          "description": "Maximum number of commits to show in the selection list"
        },
        "commitDiffReviewer.highlightColors": {
          "type": "object",
          "default": {
            "added": "rgba(0, 255, 0, 0.2)",
            "deleted": "rgba(255, 0, 0, 0.2)",
            "modified": "rgba(255, 165, 0, 0.2)"
          }
        }
      }
    }
  },
  "extensionDependencies": ["vscode.git"]
}
```

---

## ğŸ”„ ç”¨æˆ·äº¤äº’æµç¨‹

```
1. ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ â†’ å¼¹å‡º commit åˆ—è¡¨
2. é€‰æ‹© commit â†’ æ‰«ææ‰€æœ‰æ”¹åŠ¨æ–‡ä»¶ â†’ åº”ç”¨é«˜äº®
3. è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€å¤„æ”¹åŠ¨
4. ç”¨æˆ·æµè§ˆ/å¯¼èˆªæ”¹åŠ¨ï¼š
   â”œâ”€â”€ ç‚¹å‡» Accept â†’ å–æ¶ˆé«˜äº®ï¼Œä¿æŒä»£ç 
   â”œâ”€â”€ ç‚¹å‡» Reject â†’ revert ä»£ç ï¼Œå–æ¶ˆé«˜äº®
   â””â”€â”€ ç»§ç»­ä¸‹ä¸€å¤„...
5. æ‰€æœ‰æ”¹åŠ¨å¤„ç†å®Œæ¯• â†’ æ˜¾ç¤ºæ€»ç»“ â†’ è‡ªåŠ¨ç»“æŸä¼šè¯
```

---

## âœ… éªŒæ”¶æ ‡å‡†

1. [ ] èƒ½æ­£ç¡®åˆ—å‡ºå¹¶é€‰æ‹© Git commits
2. [ ] æ‰€æœ‰æ”¹åŠ¨è¢«æ­£ç¡®è¯†åˆ«å¹¶é«˜äº®æ˜¾ç¤º
3. [ ] å¯¼èˆªåŠŸèƒ½æ­£å¸¸ï¼Œå¯è·¨æ–‡ä»¶è·³è½¬
4. [ ] Accept æ“ä½œä»…ç§»é™¤é«˜äº®
5. [ ] Reject æ“ä½œæ­£ç¡® revert ä»£ç å†…å®¹
6. [ ] çŠ¶æ€æ æ­£ç¡®æ˜¾ç¤ºè¿›åº¦ (x/y)
7. [ ] ä¼šè¯å¯æ­£å¸¸ç»“æŸå’Œæ¸…ç†
8. [ ] å¤„ç†è¾¹ç•Œæƒ…å†µä¸å´©æºƒ

---

## ğŸš€ æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

- æ”¯æŒé€‰æ‹© commit èŒƒå›´ï¼ˆä» A åˆ° Bï¼‰
- æ”¯æŒå¯¹æ¯”ä»»æ„ä¸¤ä¸ª refï¼ˆåˆ†æ”¯ã€tagï¼‰
- é›†æˆ Tree View æ˜¾ç¤ºæ‰€æœ‰æ”¹åŠ¨æ–‡ä»¶åˆ—è¡¨
- æ”¯æŒéƒ¨åˆ†è¡Œæ¥å—/æ‹’ç»ï¼ˆhunk çº§åˆ«ç»†åˆ†ï¼‰
- æ·»åŠ æ’¤é”€æ“ä½œï¼ˆUndo last rejectï¼‰
- Webview é¢æ¿å±•ç¤ºæ”¹åŠ¨æ¦‚è§ˆ

---

è¯·æŒ‰ç…§ä»¥ä¸Šéœ€æ±‚å’ŒæŒ‡å¼•ï¼Œé€æ­¥å®ç°è¿™ä¸ªæ’ä»¶ã€‚å¦‚æœ‰ä»»ä½•æŠ€æœ¯ç»†èŠ‚ä¸æ¸…æ¥šï¼Œè¯·å…ˆæå‡ºé—®é¢˜ã€‚